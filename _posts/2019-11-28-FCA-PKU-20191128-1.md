---
layout: post
title: "FCA-PKU 20191128 第1题"
date: 2019-11-28 22:00:00 +0800
categories: 
 - FCA-PKU
---

## 题目

网址 `http://quotes.money.163.com/trade/lsjysj_zhishu_000001.html?year=2019&season=3` 是上证指数历史交易数据（year=2019 表示年份，season=3 表示季度）。

<!-- more -->

完成以下要求：
1. 总目标：输入年份和季度，自动下载该网页，并形成数据文件；
2. 如果输入的年份和季度不规范，给出提示信息，并重新输入，直到正确输入为止。输入错误包括：年份范围错误，与当前相比还没有到的年份，季度输入错误，例如：不在1、2、3、4范围内等；
3. 如果输入的年份和季度没有数据，给出提示信息；
4. 自动生成文件名，文件名：`StockData_SZZS_at201903_built20191128.txt`，其中，201903表示2019年第3季度，根据程序输入而变化，20191128是文件生成的日期；
5. 采集的信息包括表格中所有数据，即日期、开盘价、最高价、最低价、收盘价、涨跌额、涨跌幅（%）、成交量（股）和成交金额（元）。文件的第一行为列名称，顺序和名称与网页保持一致，每项数据之间用英文逗号分隔。如果有小数点，按网页中保留位数；如果有千分位，删除千分位逗号；数据顺序按照日期降序排列，即越近日期的顺序越前。

## 代码

```python
import re
import time
import math
import requests

url = "http://quotes.money.163.com/trade/lsjysj_zhishu_000001.html"
now = time.strftime("%Y%m%d", time.localtime())
nowYear, nowMonth = int(now[:4]), int(now[4:6])
payLoad = {}
data = []

while True:
    year = int(input("Year: "))
    season = int(input("Season: "))
    if year > nowYear:
        print("Wrong Year!")
        continue
    elif (season <= 0) or (season > 4):
        print("Wrong Season!")
        continue
    elif (year == nowYear) and (season > math.ceil(nowMonth)/3):
        print("Wrong Season!")
        continue
    else:
        payLoad["year"] = year
        payLoad["season"] = season
        r = requests.get(url, params=payLoad)
        pattern1 = re.compile(r"<tr class=.*</td></tr>")
        tmpData = pattern1.findall(r.text)
        if tmpData:
            data = re.split(r"</td></tr>", tmpData[0])
            break
        else:
            print("No Data!")

answer = []
for i in data:
    if len(i) != 0:
        tmp = re.sub(r",", "", i)
        tmp = re.split(r"</td><td>", tmp)
        tmp[0] = re.sub(r"<tr class='.*'><td>", "", tmp[0])
        answer.append(tmp)

fileName = "StockData_SZZS_at" + str(year) + "0" + str(season) + "_built" + now + ".txt"

with open(fileName, "w", encoding="utf-8") as f:
    f.write("日期,开盘价,最高价,最低价,收盘价,涨跌额,涨跌幅(%),成交量(股),成交金额(元)\n")
    for i in answer:
        tmp = i[0]
        for j in i[1:]:
            tmp += ("," + j)
        tmp += "\n"
        f.write(tmp)
```
